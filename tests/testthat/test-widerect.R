context("geom_widerect")

data(WorldBank)
not.na <- subset(WorldBank, !(is.na(life.expectancy) | is.na(fertility.rate)))
BOTH <- function(df, top, side){
  data.frame(df,
             top=factor(top, c("Fertility rate", "Years")),
             side=factor(side, c("Years", "Life expectancy")))
}
TS <- function(df)BOTH(df, "Years", "Life expectancy")
SCATTER <- function(df)BOTH(df, "Fertility rate", "Life expectancy")
TS2 <- function(df)BOTH(df, "Fertility rate", "Years")
years <- unique(not.na[, "year", drop=FALSE])
wb.facets <-
  list(ts=ggplot()+
       xlab("")+
       geom_tallrect(aes(xmin=year-1/2, xmax=year+1/2,
                         clickSelects=year),
                     data=TS(years), alpha=1/2)+
       theme_animint(width=1000, height=800)+
       geom_line(aes(year, life.expectancy, group=country, colour=region,
                     clickSelects=country),
                 data=TS(not.na), size=4, alpha=3/5)+
       geom_point(aes(year, life.expectancy, color=region, size=population,
                      showSelected=country, clickSelects=country),
                  data=TS(not.na))+
       
       geom_line(aes(fertility.rate, year, group=country, colour=region,
                     clickSelects=country),
                 data=TS2(not.na), size=4, alpha=3/5)+
       geom_point(aes(fertility.rate, year, color=region, size=population,
                      showSelected=country, clickSelects=country),
                  data=TS2(not.na))+
       geom_widerect(aes(ymin=year-1/2, ymax=year+1/2,
                         clickSelects=year),
                     data=TS2(years), alpha=1/2)+
       
       geom_point(aes(fertility.rate, life.expectancy, clickSelects=country,
                      showSelected=year, colour=region, size=population,
                      key=country), # key aesthetic for animated transitions!
                  data=SCATTER(not.na))+
       geom_text(aes(fertility.rate, life.expectancy, label=country,
                     showSelected=country, showSelected2=year,
                     clickSelects=country,
                     key=country), #also use key here!
                 data=SCATTER(not.na))+
       scale_size_animint(breaks=10^(5:9))+
       facet_grid(side ~ top, scales="free")+
       geom_text(aes(5, 85, label=paste0("year = ", year),
                     showSelected=year),
                 data=SCATTER(years)),
       time=list(variable="year", ms=1000),
       bar=ggplot()+
       theme_animint(height=2400)+
       geom_bar(aes(country, life.expectancy, fill=region,
                    showSelected=year, clickSelects=country,
                    key=country),
                data=not.na, stat="identity", position="identity")+
       coord_flip(),
       duration=list(year=1000),
       first=list(year=1975, country=c("United States", "Vietnam")),
       selector.types=list(country="multiple"),
       title="World Bank data (multiple selection, facets)")

info <- animint2HTML(wb.facets)

test_that("widerect renders a <rect> for every year", {
  node.set <-
    getNodeSet(info$html,
               '//g[@class="geom6_widerect_ts"]//g[@class="PANEL1"]//rect')
  expect_equal(length(node.set), nrow(years))
  for(node in node.set){
    sizes <- as.numeric(xmlAttrs(node)[c("height", "width")])
    expect_true(all(sizes > 0))
  }
})

getYear <- function(html){
  node.set <- getNodeSet(html, '//g[@class="geom9_text_ts"]//text')
  expect_equal(length(node.set), 1)
  xmlValue(node.set[[1]])
}

test_that("animation updates", {
  old.year <- getYear(info$html)
  Sys.sleep(1) #wait for one animation frame.
  new.html <- XML::htmlParse(remDr$getPageSource(), asText = TRUE)
  new.year <- getYear(new.html)
  expect_true(old.year != new.year)
})

clickID <- function(...){
  v <- c(...)
  stopifnot(length(v) == 1)
  e <- remDr$findElement("id", as.character(v))
  e$clickElement()
}

getHTML <- function(){
  XML::htmlParse(remDr$getPageSource(), asText = TRUE)
}

clickID("show_hide_animation_controls")

test_that("pause stops animation", {
  clickID("play_pause")
  old.html <- getHTML()
  old.year <- getYear(old.html)
  Sys.sleep(1)
  new.html <- getHTML()
  new.year <- getYear(new.html)
  expect_true(old.year == new.year)
})

test_that("play restarts animation", {
  old.html <- getHTML()
  old.year <- getYear(old.html)
  clickID("play_pause")
  Sys.sleep(2)
  new.html <- getHTML()
  new.year <- getYear(new.html)
  expect_true(old.year != new.year)
})

e <- remDr$findElement("id", "updates_ms")
e$clickElement()
e$clearElement()
e$sendKeysToElement(list("3000", key="enter"))

test_that("pause stops animation (second time)", {
  clickID("play_pause")
  old.html <- getHTML()
  old.year <- getYear(old.html)
  Sys.sleep(1)
  new.html <- getHTML()
  new.year <- getYear(new.html)
  expect_true(old.year == new.year)
})

test_that("play restarts animation (slower)", {
  old.html <- getHTML()
  old.year <- getYear(old.html)
  clickID("play_pause")
  Sys.sleep(1)
  new.html <- getHTML()
  new.year <- getYear(new.html)
  expect_true(old.year == new.year)
  Sys.sleep(3)
  newer.html <- getHTML()
  newer.year <- getYear(newer.html)
  expect_true(old.year != newer.year)
})

